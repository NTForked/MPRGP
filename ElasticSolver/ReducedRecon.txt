#version 120
#extension GL_ARB_gpu_shader5 : enable

varying vec3 nor;
varying vec3 pos;

uniform samplerBuffer coordR;
uniform samplerBuffer basisR;
uniform int nrBasis,colOff;

void main(void)  
{        
	pos=gl_Vertex.xyz;
	mat3 F=mat3(1.0);
	int base=gl_VertexID*4;
	for(int i=0;i<nrBasis;i++,base+=colOff){
		float b=texelFetchBuffer(coordR,i).x;
		pos+=texelFetchBuffer(basisR,base).xyz*b;
		F[0]+=texelFetchBuffer(basisR,base+1).xyz*b;
		F[1]+=texelFetchBuffer(basisR,base+2).xyz*b;
		F[2]+=texelFetchBuffer(basisR,base+3).xyz*b;
	}
	nor=transpose(inverse(F))*gl_Normal;
	gl_Position=gl_ModelViewProjectionMatrix*vec4(0.0);
}
   